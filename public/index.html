<html>
<head>
  <title>Github Milestones</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="/stylesheets/style.css">
  <script>

  $(function() {

    var daydiff = function(first, second) {
        return Math.abs((second-first)/(1000*60*60*24));
    }

    var getDateHeaders = function(data) {

      var startDate = new Date(data[0].closed_at);
      var endDate = new Date(data[data.length-1].closed_at);
      var maxDaysBetween = daydiff(startDate, endDate);

      var middlePt = new Date();
      middlePt.setDate(startDate.getDate() + Math.floor(maxDaysBetween/2));

      var quarter = new Date();
      quarter.setDate(startDate.getDate() + Math.floor(maxDaysBetween/4))

      var threequarters = new Date();
      quarter.setDate(middlePt.getDate() + Math.floor(maxDaysBetween/4))

      return {
        startDate: startDate.toISOString().slice(0, 10),
        endDate: endDate.toISOString().slice(0, 10),
        middlePt: middlePt.toISOString().slice(0, 10),
        quarter: quarter.toISOString().slice(0, 10),
        threequarters: threequarters.toISOString().slice(0, 10),
        maxDaysBetween: maxDaysBetween
      };
    };

    var getXPos = function(curDate, headers, maxWidth) {

      return daydiff(new Date(headers.startDate), new Date(curDate)) / headers.maxDaysBetween * (maxWidth-10) ;

    };

    var renderTable = function(data, headers) {
      var thetable = $('<table></table>');

      thetable.append('<thead><tr><th>milestone</th><th>' + headers.startDate + '</th><th>' + headers.quarter + '</th><th>' + headers.middlePt + '</th><th>' + headers.threequarters + '</th><th>' + headers.endDate + '</th></tr></thead>');

      for (var i = 0; i < data.length; i++) {
        var thetr = $('<tr></tr>');
        var thetitle = $('<td>' + data[i].title + '</td>');
        var theX = $('<td colspan=5></td>');
        theX.append('<span data-tooltip="' + data[i].closed_at + '" style="position: relative; left: ' + getXPos(data[i].closed_at, headers, 700) + 'px">X</span>');
        thetr.append(thetitle);
        thetr.append(theX);
        thetable.append(thetr);
      }
      $('body').append(thetable);
    };

    $("#gitform").submit(function() {

        var url = "/getMilestones";

        $.ajax({
               type: "POST",
               url: url,
               data: $("#gitform").serialize(),
               success: function(data)
               {
                   console.log(data);
                   var parsed = JSON.parse(data);
                   renderTable(parsed, getDateHeaders(parsed) );
               }
             });

        return false;
    });

  });


  </script>
</head>
<body>
  <h1>Let's get those Github Milestones!</h1>
  <form id='gitform'>
    <textarea rows="10" cols="80" name='urls'></textarea>
    <input type="submit" value="Submit">
  </form>

  <table id='results'>
  </table>
</body>
</html>
